<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type="x-icon" href="admaa.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMAA - Forms Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --light: #ecf0f1;
            --dark: #343a40;
            --gray: #7f8c8d;
            --border: #e1e5e9;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --card-bg: #ffffff;
            --body-bg: #f8f9fa;
            --text: #333333;
        }

        body.dark-theme {
            --primary: #3b8bba;
            --secondary: #34495e;
            --light: #2c3e50;
            --dark: #ecf0f1;
            --body-bg: #1a252f;
            --card-bg: #2c3e50;
            --text: #ecf0f1;
            --border: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text);
            transition: all 0.3s;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto auto;
            gap: 15px;
        }

        /* Top Header - spans full width */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Top Container - Dashboard Controls */
        .top-container {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Dashboard Controls (Left side of top) */
        .dashboard-controls {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .dashboard-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle {
            margin-top: auto;
        }

        /* Regions Container (Right side of top) */
        .regions-container {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .regions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .regions-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .regions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .region-card {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .region-card:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }

        .region-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .region-count {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Middle Row - Filters and Total Forms */
        .middle-container {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Filters Container (Left side of middle) */
        .filters-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-group {
            flex: 1;
        }

        .filter-label {
            font-size: 12px;
            color: var(--text);
            margin-bottom: 5px;
            display: block;
        }

        select {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: var(--card-bg);
            color: var(--text);
            font-size: 12px;
            width: 100%;
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Total Forms Container (Right side of middle) */
        .total-forms-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .total-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
            line-height: 1;
        }

        .total-label {
            font-size: 14px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Bottom Container - Charts */
        .bottom-container {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            height: 200px;
            position: relative;
            flex-grow: 1;
        }

        /* Buttons */
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
            margin-top: 5px;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1a252f;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .modal-item {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .modal-item:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }

        .modal-item-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 5px;
        }

        .modal-item-count {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            grid-column: 1 / -1;
        }

        .region-loading {
            display: none;
            text-align: center;
            padding: 5px;
            font-size: 11px;
            color: var(--gray);
            margin-top: 5px;
        }

        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .small-spinner {
            border: 2px solid var(--light);
            border-top: 2px solid var(--success);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto auto;
            }
            
            .top-container {
                grid-column: 1;
                grid-template-columns: 1fr;
            }
            
            .middle-container {
                grid-column: 1;
                grid-template-columns: 1fr;
            }
            
            .bottom-container {
                grid-column: 1;
                grid-template-columns: 1fr;
            }
            
            .regions-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .regions-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .modal-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .bottom-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
                gap: 10px;
            }
            
            .header, .card {
                padding: 12px;
            }
            
            .total-number {
                font-size: 28px;
            }
            
            .chart-container {
                height: 180px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
    </style>
</head>
<body class="light-theme">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                ADMAA Forms Dashboard
            </div>
            <div class="theme-toggle">
                <button class="btn btn-secondary" onclick="toggleTheme()">
                <i class="fas fa-moon"></i> Toggle Theme
                </button>
             </div>
        </div>

        <!-- Top Container: Dashboard Controls (Left) and Regions (Right) -->
        <div class="top-container">
            <!-- Left: Dashboard Controls -->
            <div class="dashboard-controls">
                <div class="dashboard-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Employee Status
                </div>
            </div>

            <!-- Right: Regions Container -->
            <div class="regions-container">
                <div class="regions-header">
                    <div class="regions-title">
                        <i class="fas fa-map-marker-alt"></i> Forms by Region
                    </div>
                    <button class="btn btn-success" onclick="refreshRegionData()" id="regionRefreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh Regions
                    </button>
                </div>
                <div class="region-loading" id="regionLoading">
                    <div class="small-spinner"></div> Loading...
                </div>
                <div class="regions-grid" id="regionsGrid">
                    <!-- Regions will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Middle Container: Filters (Left) and Total Forms (Right) -->
        <div class="middle-container">
            <!-- Left: Filters -->
            <div class="filters-card">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">From Month:</label>
                        <select id="fromMonth">
                            <option value="">All</option>
                            <option value="JAN">JAN</option>
                            <option value="FEB">FEB</option>
                            <option value="MAR">MAR</option>
                            <option value="APR">APR</option>
                            <option value="MAY">MAY</option>
                            <option value="JUN">JUN</option>
                            <option value="JUL">JUL</option>
                            <option value="AUG">AUG</option>
                            <option value="SEP">SEP</option>
                            <option value="OCT">OCT</option>
                            <option value="NOV">NOV</option>
                            <option value="DEC">DEC</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">To Month:</label>
                        <select id="toMonth">
                            <option value="">All</option>
                            <option value="JAN">JAN</option>
                            <option value="FEB">FEB</option>
                            <option value="MAR">MAR</option>
                            <option value="APR">APR</option>
                            <option value="MAY">MAY</option>
                            <option value="JUN">JUN</option>
                            <option value="JUL">JUL</option>
                            <option value="AUG">AUG</option>
                            <option value="SEP">SEP</option>
                            <option value="OCT">OCT</option>
                            <option value="NOV">NOV</option>
                            <option value="DEC">DEC</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="loadDashboardData()">
                    <i class="fas fa-sync-alt"></i> Refresh Dashboard
                </button>
            </div>

            <!-- Right: Total Forms -->
            <div class="total-forms-card">
                <div class="total-number" id="totalForms">0</div>
                <div class="total-label">Total Forms Submitted</div>
            </div>
        </div>

        <!-- Bottom Container: Charts -->
        <div class="bottom-container">
            <!-- Left: Monthly Forms -->
            <div class="chart-card">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i> Monthly Forms
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Middle: Banks -->
            <div class="chart-card">
                <div class="card-title">
                    <i class="fas fa-chart-pie"></i> Banks
                </div>
                <div class="chart-container">
                    <canvas id="banksChart"></canvas>
                </div>
            </div>

            <!-- Right: Status -->
            <div class="chart-card">
                <div class="card-title">
                    <i class="fas fa-chart-bar"></i> Status
                </div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading dashboard data...</p>
        </div>
    </div>

    <!-- Region Modal -->
    <div class="modal" id="regionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-map"></i>
                    <span id="modalRegionTitle">Region Details</span>
                </div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const N8N_DASHBOARD_WEBHOOK = 'https://noral.gleeze.com/webhook/dashbord';
        const N8N_REGION_DATA_WEBHOOK = 'https://noral.gleeze.com/webhook/region-data';
        
        // Chart instances
        let monthlyChart = null;
        let banksChart = null;
        let statusChart = null;
        
        // Current modal state
        let currentModalType = '';
        let currentRegion = '';
        let currentCity = '';

        // Regions data structure
        const regionsData = {
            'NORTH': {
                name: 'North Region',
                totalForms: 0,
                cities: {
                    'ISLAMABAD': { name: 'Islamabad', totalForms: 0 },
                    'SKARDU': { name: 'Skardu', totalForms: 0 }
                }
            },
            'CENTRAL': {
                name: 'Central Region',
                totalForms: 0,
                cities: {
                    'LAHORE': { name: 'Lahore', totalForms: 0 },
                    'SUKKUR': { name: 'Sukkur', totalForms: 0 }
                }
            },
            'SOUTH': {
                name: 'South Region',
                totalForms: 0,
                cities: {
                    'KARACHI': { 
                        name: 'Karachi', 
                        totalForms: 0,
                        locations: [
                            'BAHRIA TOWN', 'BALDIA TOWN', 'CLIFTON', 'CLIFTON BLOCK 2', 'CREEK WALK',
                            'DHA', 'EXPO CENTER', 'F.B AREA', 'GOLIMAR', 'GUL PLAZA',
                            'GULISTAN-E-JOUHAR', 'GULSHAN-E-IQBAL', 'II CHUNDIGARH', 'JODIA BAZAR',
                            'KEAMARI', 'KORANGI', 'LANDHI', 'LE MARKET', 'LIAQUATABAD', 'LYARI',
                            'MACHAR COLONY', 'MALIR', 'MANGHOPIR', 'MANZOOR COLONY', 'MARIPURE',
                            'MAYMAR', 'MEHMOODABAD', 'N.KARACHI', 'N.NAZIMABAD', 'NAZIMABAD',
                            'ORANGI TOWN', 'PECHS', 'PIB COLONY', 'RT', 'SADDAR', 'SAFOORA',
                            'SCHEME 33', 'SHABBIRABAD', 'SHAH FAISAL', 'SHAHRAH-E-FAISAL',
                            'SHERSHAH', 'SITE AREA', 'SULTANABAD', 'SURJANI TOWN', 'TARIQ ROAD'
                        ]
                    },
                    'HYDERABAD': { name: 'Hyderabad', totalForms: 0 }
                }
            }
        };

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-theme');
            body.classList.remove(isDark ? 'dark-theme' : 'light-theme');
            body.classList.add(isDark ? 'light-theme' : 'dark-theme');
            
            if (monthlyChart) monthlyChart.update();
            if (banksChart) banksChart.update();
            if (statusChart) statusChart.update();
        }

        // Modal Functions
        function openModal(type, title, data) {
            currentModalType = type;
            document.getElementById('modalRegionTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = generateModalContent(type, data);
            document.getElementById('regionModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('regionModal').style.display = 'none';
            currentModalType = '';
            currentRegion = '';
            currentCity = '';
        }

        function generateModalContent(type, data) {
            let html = '';
            
            if (type === 'region') {
                const region = regionsData[data.region];
                html = `<div class="modal-grid" id="citiesGrid">`;
                
                Object.entries(region.cities).forEach(([cityCode, cityData]) => {
                    html += `
                        <div class="modal-item" onclick="openCityModal('${data.region}', '${cityCode}')">
                            <div class="modal-item-name">${cityData.name}</div>
                            <div class="modal-item-count">${cityData.totalForms}</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else if (type === 'city') {
                const city = regionsData[data.region].cities[data.city];
                html = `<div class="modal-grid" id="locationsGrid">`;
                
                if (city.locations) {
                    city.locations.forEach(location => {
                        html += `
                            <div class="modal-item">
                                <div class="modal-item-name">${location}</div>
                                <div class="modal-item-count">0</div>
                            </div>
                        `;
                    });
                } else {
                    html += `<p>No location data available for ${city.name}</p>`;
                }
                
                html += `</div>`;
            }
            
            return html;
        }

        function openRegionModal(region) {
            currentRegion = region;
            openModal('region', `${regionsData[region].name} - Cities`, { region: region });
        }

        function openCityModal(region, city) {
            currentCity = city;
            openModal('city', `${regionsData[region].cities[city].name} - Locations`, { 
                region: region, 
                city: city 
            });
        }

        // Update Regions Display
        function updateRegionsDisplay() {
            const regionsGrid = document.getElementById('regionsGrid');
            regionsGrid.innerHTML = '';
            
            Object.entries(regionsData).forEach(([regionCode, regionData]) => {
                const regionCard = document.createElement('div');
                regionCard.className = 'region-card';
                regionCard.onclick = () => openRegionModal(regionCode);
                
                regionCard.innerHTML = `
                    <div class="region-name">${regionData.name}</div>
                    <div class="region-count">${regionData.totalForms}</div>
                `;
                
                regionsGrid.appendChild(regionCard);
            });
        }

        // ==============================================
        // SEPARATE REGION DATA REFRESH
        // ==============================================
        async function refreshRegionData() {
            console.log('=== REFRESHING REGION DATA ===');
            
            // Show loading for regions
            document.getElementById('regionLoading').style.display = 'block';
            const refreshBtn = document.getElementById('regionRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<div class="small-spinner"></div> Loading...';
            
            try {
                // THIS IS THE JSON SENT TO N8N FOR REGION DATA:
                const requestData = {
                    action: "get_region_data",
                    fromMonth: "",  // EMPTY for lifetime data
                    toMonth: ""     // EMPTY for lifetime data
                };
                
                console.log('Sending to region webhook:', requestData);
                
                const response = await fetch(N8N_REGION_DATA_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Region response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Region data received:', data);
                
                // Process the region data
                if (data && data.regions) {
                    updateRegionsWithRealData(data);
                } else if (data && data.totalForms !== undefined) {
                    updateRegionsWithRealData({ regions: [data] });
                } else {
                    console.log('No valid region data found');
                    // Keep existing region data
                }
                
            } catch (error) {
                console.error('Error loading region data:', error);
                alert('Failed to load region data. Check console for details.');
            } finally {
                document.getElementById('regionLoading').style.display = 'none';
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Regions';
            }
        }

        // Update regions with real API data
        function updateRegionsWithRealData(regionData) {
            console.log('Updating regions with real data:', regionData);
            
            // Clear existing data
            Object.keys(regionsData).forEach(region => {
                regionsData[region].totalForms = 0;
                Object.keys(regionsData[region].cities).forEach(city => {
                    regionsData[region].cities[city].totalForms = 0;
                });
            });
            
            // Update with real data
            if (Array.isArray(regionData.regions)) {
                regionData.regions.forEach(region => {
                    if (regionsData[region.region]) {
                        regionsData[region.region].totalForms = region.totalForms || 0;
                        
                        if (region.cities) {
                            region.cities.forEach(city => {
                                if (regionsData[region.region].cities[city.city]) {
                                    regionsData[region.region].cities[city.city].totalForms = city.totalForms || 0;
                                }
                            });
                        }
                    }
                });
            }
            
            updateRegionsDisplay();
        }

        // ==============================================
        // DASHBOARD DATA REFRESH (with filters)
        // ==============================================
        async function loadDashboardData() {
            const fromMonth = document.getElementById('fromMonth').value;
            const toMonth = document.getElementById('toMonth').value;
            
            console.log('=== REFRESHING DASHBOARD DATA ===');
            console.log('Filters:', { fromMonth, toMonth });
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            
            try {
                // THIS IS THE JSON SENT TO N8N FOR DASHBOARD DATA:
                const requestData = {
                    action: "get_dashboard_data",
                    fromMonth: fromMonth,
                    toMonth: toMonth
                };
                
                console.log('Sending to dashboard webhook:', requestData);
                
                const response = await fetch(N8N_DASHBOARD_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Dashboard response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Dashboard data received:', data);
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                // Process the data
                if (data) {
                    let dashboardData;
                    if (Array.isArray(data) && data.length > 0) {
                        dashboardData = data[0];
                    } else if (data.totalForms !== undefined) {
                        dashboardData = data;
                    } else {
                        console.log('No valid data found');
                        resetDashboard();
                        return;
                    }
                    
                    updateDashboard(dashboardData);
                    
                    // DO NOT update regions here - regions are separate
                    
                } else {
                    console.log('No data in response');
                    resetDashboard();
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loading').style.display = 'none';
                resetDashboard();
            }
        }

        // Update Dashboard with Data
        function updateDashboard(dashboardData) {
            console.log('Updating dashboard with:', dashboardData);
            
            // Update total forms
            const totalForms = dashboardData.totalForms || 0;
            document.getElementById('totalForms').textContent = totalForms;
            
            // Update charts
            updateCharts(dashboardData);
        }

        // Reset Dashboard
        function resetDashboard() {
            document.getElementById('totalForms').textContent = '0';
            
            if (monthlyChart) monthlyChart.destroy();
            if (banksChart) banksChart.destroy();
            if (statusChart) statusChart.destroy();
            
            createEmptyCharts();
        }

        // Create Empty Charts
        function createEmptyCharts() {
            const ctx1 = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        label: 'Forms',
                        data: [0],
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            const ctx2 = document.getElementById('banksChart').getContext('2d');
            banksChart = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        data: [100],
                        backgroundColor: ['#e1e5e9']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 10,
                                padding: 8,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
            
            const ctx3 = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        data: [100],
                        backgroundColor: ['#e1e5e9']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 10,
                                padding: 8,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // Update Charts with Data
        function updateCharts(dashboardData) {
            // Monthly Chart
            if (monthlyChart) monthlyChart.destroy();
            if (dashboardData.months && dashboardData.months.length > 0) {
                const months = dashboardData.months.map(m => m.month);
                const counts = dashboardData.months.map(m => m.count);
                
                const ctx1 = document.getElementById('monthlyChart').getContext('2d');
                monthlyChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Forms Submitted',
                            data: counts,
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: { size: 9 }
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 9 }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
            
            // Banks Chart
            if (banksChart) banksChart.destroy();
            if (dashboardData.banks && dashboardData.banks.length > 0) {
                const topBanks = dashboardData.banks.slice(0, 5);
                const bankNames = topBanks.map(b => b.bank);
                const bankCounts = topBanks.map(b => b.count);
                
                const bankColors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
                
                const ctx2 = document.getElementById('banksChart').getContext('2d');
                banksChart = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: bankNames,
                        datasets: [{
                            data: bankCounts,
                            backgroundColor: bankColors.slice(0, topBanks.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 8,
                                    padding: 6,
                                    font: { size: 9 }
                                }
                            }
                        }
                    }
                });
            }
            
            // Status Chart
            if (statusChart) statusChart.destroy();
            if (dashboardData.statuses && dashboardData.statuses.length > 0) {
                const statusNames = dashboardData.statuses.map(s => s.status);
                const statusCounts = dashboardData.statuses.map(s => s.count);
                
                const statusColors = statusNames.map(status => {
                    if (status.includes('DEPLOYED')) return '#2ecc71';
                    if (status.includes('PENDING')) return '#f39c12';
                    if (status.includes('SENT')) return '#3498db';
                    if (status.includes('PRINT')) return '#9b59b6';
                    if (status.includes('CLOSED')) return '#95a5a6';
                    if (status.includes('IBAN')) return '#1abc9c';
                    if (status.includes('HANDED')) return '#e74c3c';
                    if (status.includes('RETURN')) return '#c0392b';
                    if (status.includes('WAITING')) return '#f1c40f';
                    return '#7f8c8d';
                });
                
                const ctx3 = document.getElementById('statusChart').getContext('2d');
                statusChart = new Chart(ctx3, {
                    type: 'doughnut',
                    data: {
                        labels: statusNames,
                        datasets: [{
                            data: statusCounts,
                            backgroundColor: statusColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 8,
                                    padding: 6,
                                    font: { size: 9 }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DASHBOARD INITIALIZING ===');
            
            createEmptyCharts();
            updateRegionsDisplay();
            
            // Set default month filters
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const now = new Date();
            const currentMonthIndex = now.getMonth();
            const currentMonth = months[currentMonthIndex];
            
            document.getElementById('fromMonth').value = months[currentMonthIndex - 1] || 'JAN';
            document.getElementById('toMonth').value = currentMonth;
            
            // Load initial dashboard data
            loadDashboardData();
            
            // Auto-refresh dashboard every 5 minutes
            setInterval(loadDashboardData, 5 * 60 * 1000);
            
            // Close modal when clicking outside
            document.getElementById('regionModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
